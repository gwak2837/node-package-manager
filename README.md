# Node.js 패키지 매니저

## Node.js Module Resolution

require, import 모두 절대경로, 상대경로를 사용하지 않고 패키지 이름만 사용하면 현재폴더부터 node_modules 폴더를 탐색해서 패키지가 있는지 확인하고 없으면 상위폴더로 이동해서 node_modules 폴더를 탐색, 루트까지 node_modules이 없어야 패키지를 찾을 수 없는 에러 발생하고 이 방식때문에 설치하지 않은 패키지를 불러서 사용하는 것이 가능. 패키지탐색 비용이 듦

기술적인 배경으로 노드의 패키지 구조는 DAG의 형태이고 파일 시스템은 트리 형태라서 생기는 문제입니다.

둘은 얼핏 봐서는 큰 차이가 없어보이지만 실제로는 DAG가 트리보다 더 넓은 개념이기 때문에, 1. 본인이 설치한 패키지만 사용해야 하고 2. 하나의 패키지는 1번만 깔린다는 제약조건이 있다면, 특정 종속관계는 설치하는게 불가능해집니다.

따라서 패키지 매니저들이 여러가지 방법으로 간선을 늘려서 DAG처럼 만들게 됩니다. 그 방법에는 1. 동일한 패키지를 여러개 설치하기 2. 팬텀 디펜던시를 허용하기 3. 심볼릭 링크를 사용하기 등이 있습니다. 이렇게 간선이 생겨서 트리 위에서 DAG를 구현할 수 있게 됩니다.

그렇기 때문에 패키지 종속관계랑 파일시스템 구조가 1:1 매칭이 되지 않고, 패키지 매니저별로 다른 구조로 결정되고, 전체 설치 용량이나 읽을 수 있는 디펜던시의 차이가 발생합니다.

루트폴더에서 `npm i express` 로 패키지를 설치한 뒤 node_modules을 `/Users` 폴더로 옮기면 하위 폴더에서는 express패키지를 설치하지 않고도 불러올 수 있음

`require.resolve('express')` 로 패키지가 어디에 위치했는지 확인 가능

## NPM

워크스페이스 폴더에서 패키지 설치하면 의존성이 루트 경로에 설치됨

`package-lock.json`이 먼저 생성되어있으면 해당 파일 기준으로 패키지가 설치됨
워크스페이스 내부 패키지에서 설치하면 전체 패키지가 설치되지 않고 현재 패키지의 의존성에 연결된 패키지만 설치됨
`packagas/frontend` 패키지 설치시 연결된 종속성 외 패키지는 설치되지 않음
먼저 설치된 패키지의 다른 버전이 새로 설치하려는 패키지에서 필요해지면, 새 패키지의 폴더 내부에 node_modules 폴더가 생성되고 해당 폴더 내부에 새 버전이 설치 됨 → 같은 버전의 패키지가 여러개 설치될 수 있음
먼저 설치된 기준은 package-lock에서 관리하는 것으로 보임 package-lock삭제시 초기화

**Node.js의 Module Resolution 사용 현재 폴더에 없으면 프로젝트 루트폴더까지 탐색하게 되어 비효율적임**

## Yarn Classic

한 패키지에서 설치하면 모든 하위 패키지 전체 설치, 의존성 바뀐것도 반영됨
~~가장 깊은 뎁스에 있는 패키지를 루트 위치의 `node_modules`에 설치하는 것으로 보임~~ → 가장 많이 쓰는 버전이 올라감
한 패키지의 다른 버전 사용하면 같은 버전의 패키지가 여러개 생기는 문제

**Node.js의 Module Resolution 사용 npm과 같은 문제점,** 같은 버전의 패키지가 여러개 생기는 문제

## Yarn Berry PNP linker

`yarn set version 2`명령어로 설치
`yarn node index` 형태의 명령어로 코드를 실행할 수 있고 이때 npm패키지의 설치폴더는 `.yarn/cache` 폴더안에 zip파일로 설치됨
그러나 기본 Node.js와 호환되지는 않는데 yarn을 이용하지않고 node를 이용해서 실행하면 작동하지 않음
`.yarnrc.yml` 파일에 `nodeLinker: pnp`를 설정하거나 생략

**yarn에서 제공하는 `.pnp.js`를 이용하고 있어서 require와 다르게 동작**

모든 버전이 설치되니 PNPM과도 유사함

## Yarn Berry node_modules linker

node_modules 폴더를 생성하는데 yarn v1과 비슷한 방식을 사용
여전히 패키지가 복사되는 문제가 있지만 v1에 비하면 조금 똑똑한 것으로 보임 → 더 많이 사용하는 패키지 버전을 글로벌에 설치하고 나머지 버전은 워크스페이스 내부에 설치
`.yarnrc.yml` 파일에 `nodeLinker: node_modules` 설정

**npm과 같은 문제점**

## PNPM

npm, yarn과 다른 워크스페이스 문법 사용

- `pnpm-workspace.yaml` 파일이 필요
- 의존성에 `"workspace:*"` 을 입력해줘야 인식

심볼릭 링크를 적극적으로 활용
사용한 패키지의 모든 버전이 루트폴더의 `node_modules/.pnpm` 폴더 내에 `패키지이름@버전` 형태로 모두 설치되고 워크스페이스 패키지에서는 node_modules폴더를 생성하고 내부에 사용하는 패키지의 심볼릭 링크를 생성

**Node.js의 Module Resolution 사용, 워크스페이스 폴더에서 바로 접근가능하도록 심볼릭 링크를 생성해서 빠르게 찾을 수 있음**

## 기타

#### node_modules 삭제

```bash
find . -name \\"node_modules\\" -type d -prune -exec rm -rf '{}' +
```
